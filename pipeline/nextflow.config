/*
========================================================================================
    GeneXOmics Perturb-Seq Pipeline Configuration
========================================================================================
*/

params {
    // ==================== Input/Output ====================
    // Choose ONE input type: bcl_dir OR fastq_dir
    
    bcl_dir              = null    // Path to BCL run directory (e.g., data/production_runs/run_20260113)
    fastq_dir            = null    // Path to FASTQ directory (e.g., data/examples/fastq)
    
    // Sample Sheet (optional for BCL processing)
    // If provided: bcl2fastq demultiplexes samples by index
    // If omitted: bcl2fastq generates Undetermined_S0 files (no demultiplexing)
    samplesheet          = null    // Path to SampleSheet.csv (optional)
    
    outdir               = './results'
    
    // Work and logs directories
    workdir              = './work'
    
    // ==================== Reference Data ====================
    // Cell Ranger compatible reference genome
    // Download from: https://www.10xgenomics.com/support/software/cell-ranger/downloads
    reference            = null    // e.g., data/references/refdata-gex-GRCh38-2024-A
    
    // Feature reference for Perturb-Seq (CRISPR guide capture)
    feature_ref          = null    // e.g., data/feature_reference.csv
    
    // Multi-modal config (optional - for cellranger multi)
    // If provided: forces cellranger multi
    // If null: auto-detects based on directory structure
    multi_config         = null    // e.g., data/10x_test_data/config.csv
    
    // ==================== Cell Ranger Parameters ====================
    // Expected number of cells. Set to null (or 0) to use Cell Ranger's auto-detection (EmptyDrops)
    expected_cells       = 0    
    
    // ==================== Guide Assignment Parameters (Perturb-Seq) ====================
    skip_guide_assignment   = false        // Set to true to skip guide assignment
    guide_assignment_method = 'threshold'  // Method: 'threshold' or 'max'
    guide_count_threshold   = 5            // Minimum UMI count to assign a guide
    
    // ==================== QC Thresholds ====================
    min_genes            = 200     // Minimum genes per cell (filter low-quality cells)
    min_cells            = 3       // Minimum cells per gene (filter rare genes)
    max_mito_pct         = 20      // Maximum mitochondrial percentage (filter dying cells)
    
    // ==================== Analysis Parameters ====================
    n_pcs                = 50      // Number of principal components for dimensionality reduction
    resolution           = 0.5     // Leiden clustering resolution (higher = more clusters)
    
    // ==================== Resource Limits ====================
    max_cpus             = 16
    max_memory           = '64.GB'
    max_time             = '24.h'
    
    // ==================== Skip Options ====================
    skip_fastqc          = false   // Skip FastQC quality control
    skip_alignment       = false   // Skip CellRanger Count (start from existing matrix)
    skip_guide_assignment = false  // Skip guide assignment (for non-Perturb-Seq data)
    skip_qc_filter       = false   // Skip QC filtering
    skip_clustering      = false   // Skip clustering analysis
    skip_analysis        = false   // Skip all downstream analysis (QC + clustering)
    
    // ==================== Options ====================
    help                 = false
}

// Process resource requirements
process {
    
    // Default resources
    cpus   = 2
    memory = 4.GB
    time   = 2.h
    
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'
    
    // Process-specific resources
    withLabel: 'low_memory' {
        cpus   = 2
        memory = 8.GB
        time   = 2.h
    }
    
    withLabel: 'medium_memory' {
        cpus   = 4
        memory = 16.GB
        time   = 6.h
    }
    
    withLabel: 'high_memory' {
        cpus   = { Math.min(16, params.max_cpus) }
        memory = { params.max_memory }
        time   = 12.h
    }
    
    // Process-specific containers
    withName: 'BCL2FASTQ' {
        container = 'genexomics/bcl2fastq:1.0'
    }
    
    withName: 'FASTQC' {
        container = 'genexomics/fastqc:1.0'
    }
    
    withName: 'CELLRANGER_COUNT' {
        container = 'genexomics/cellranger:1.0'
    }
    
    withName: 'CELLRANGER_MULTI' {
        container = 'genexomics/cellranger:1.0'
    }
    
    withName: 'QC_FILTER' {
        container = 'genexomics/scanpy-qc:1.0'
    }
    
    withName: 'CLUSTERING' {
        container = 'genexomics/analysis:1.0'
    }
}

// Container settings
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g) -v $PWD:$PWD'
    fixOwnership = true
    // Enable Rosetta emulation for ARM Macs to run AMD64 images
    registry = null
}

singularity {
    enabled = false
    autoMounts = true
    cacheDir = "$HOME/.singularity/cache"
}

// Execution profiles
profiles {
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g) -v $PWD:$PWD'
        singularity.enabled = false
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        docker.enabled = false
    }
    
    local {
        executor {
            name = 'local'
            cpus = params.max_cpus
            memory = params.max_memory
        }
    }
    
    stub {
        docker.enabled = false
        executor.name = 'local'
    }
    
    aws {
        includeConfig 'conf/aws.config'
    }
    
    test {
        params {
            bcl_dir = null
            fastq_dir = './data/test'
            outdir = './results/test'
            expected_cells = 1000
            max_cpus = 4
            max_memory = '16.GB'
        }
    }
    
    stub {
        // Use stub runs for testing pipeline logic without real execution
        params.outdir = './results/stub'
    }
}

// Reporting
timeline {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/timeline.html"
}

report {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/report.html"
}

trace {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt'
}

dag {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}

// Manifest
manifest {
    name            = 'genexomics-perturbseq-pipeline'
    author          = 'João Cardoso'
    homePage        = 'https://github.com/yourusername/genexomics-pipeline'
    description     = 'Automated Perturb-Seq analysis pipeline for GeneXOmics - from BCL to clustered single-cell data'
    mainScript      = 'main.nf'
    nextflowVersion = '>=22.10.0'
    version         = '1.0.0'
}

// Function to print help message
def helpMessage() {
    log.info"""
    ═══════════════════════════════════════════════════════════════════════
    GeneXOmics Perturb-Seq Pipeline v${manifest.version}
    ═══════════════════════════════════════════════════════════════════════
    
    Usage:
      nextflow run main.nf [options]
    
    Required arguments:
      --reference               Path to Cell Ranger compatible reference genome
      --bcl_dir                 Path to BCL directory (for primary analysis)
        OR
      --fastq_dir               Path to FASTQ directory (skip primary analysis)
    
    Optional arguments:
      --samplesheet             CSV samplesheet (required if using --bcl_dir)
      --outdir                  Output directory (default: ./results)
      --expected_cells          Expected number of cells (default: 5000)
      --min_genes               Min genes per cell (default: 200)
      --min_cells               Min cells per gene (default: 3)
      --max_mito_pct            Max mitochondrial % (default: 20)
      --n_pcs                   Number of PCs for analysis (default: 50)
      --resolution              Clustering resolution (default: 0.5)
    
    Profiles:
      -profile docker           Run with Docker (default)
      -profile singularity      Run with Singularity
      -profile aws              Run on AWS Batch
      -profile test             Run test dataset
      -profile stub             Test pipeline logic without execution
    
    Examples:
      # From BCL files (complete pipeline)
      nextflow run main.nf \\
        --bcl_dir /data/runs/run001 \\
        --samplesheet samples.csv \\
        --reference /refs/GRCh38 \\
        --outdir results/run001
      
      # From FASTQ files (skip primary analysis)
      nextflow run main.nf \\
        --fastq_dir /data/fastq/run001 \\
        --reference /refs/GRCh38 \\
        --outdir results/run001
      
      # Test run
      nextflow run main.nf -profile test
    
    ═══════════════════════════════════════════════════════════════════════
    """.stripIndent()
}

// Execution trace and reporting
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.svg"
}

// Work directory configuration
workDir = params.workdir

// Show help message if requested
if (params.help) {
    helpMessage()
    exit 0
}
